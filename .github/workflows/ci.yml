name: CI
on:
  push:
    branches: [ main, env/**, feat/** ]
    paths:
      - 'labs/**'
      - '.github/workflows/ci.yml'
      - '.flake8'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  syntax:
    name: syntax
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bozdogalex/bioinf-y4-lab:base
    steps:
      - uses: actions/checkout@v4
      - name: Python compile (fail fast on syntax errors)
        run: |
          python -m compileall -q "labs/01_intro&databases"
          python -m compileall -q "labs/02_alignment"
          python -m compileall -q "labs/03_formats&NGS"
          python -m compileall -q "labs/04_phylogenetics"
          python -m compileall -q "labs/05_clustering"
          python -m compileall -q "labs/06_wgcna"
          python -m compileall -q "labs/07_network_viz"

  smoke:
    name: smoke
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bozdogalex/bioinf-y4-lab:base
    steps:
      - uses: actions/checkout@v4
      - name: Run smoke
        run: python labs/00_smoke/smoke.py

  mlflow:
    name: mlflow
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bozdogalex/bioinf-y4-lab:base
    steps:
      - uses: actions/checkout@v4
      - name: MLflow smoke (no UI)
        run: python labs/00_smoke/mlflow_smoke.py --experiment "BIOINF-Y4 Demo"

  # Optional: non-blocking style advice
  lint:
    name: lint (advice)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bozdogalex/bioinf-y4-lab:base
    steps:
      - uses: actions/checkout@v4
      - name: flake8 (advisory, does not fail)
        run: flake8 labs || true
